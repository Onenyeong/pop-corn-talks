<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <title>팝콘톡</title>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"
          integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: transparent;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999;
      height: 60px; /* 헤더 높이 감소 */
    }

    header h1 {
      margin: 0;
    }

    #welcome-message {
      color: #ffcc00;
    }

    .left-container {
      margin-top: 10px; /* 상단 여백 조정 */
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 10px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }

    .center-container {
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 80px; /* 상단 여백 증가 */
    }

    .post-card {
      width: 300px; /* 가로 너비 조정 */
      margin: 10px;
      padding: 10px;
      background-color: #fff;
      border-radius: 15px; /* 테두리 반경 조정 */
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .post-card img {
      width: 100%;
      border-radius: 15px 15px 0 0; /* 테두리 반경 조정 */
    }

    .post-card h3,
    .post-card p {
      margin: 5px 0;
      padding: 0 10px;
    }

    .right-container {
      margin-top: 10px; /* 상단 여백 조정 */
      padding: 10px;
      background-color: transparent;
      border-radius: 10px;
      display: flex;
      align-items: center;
    }

    .action-buttons {
      display: flex;
      align-items: center;
    }

    .action-buttons input[type="text"] {
      padding: 10px;
      border-radius: 20px;
      border: none;
      margin-right: 10px;
      width: 200px; /* 검색 버튼 너비 조정 */
    }

    .action-buttons button {
      padding: 10px 20px;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-bottom: 10px;
      border-radius: 15px; /* 테두리 반경 조정 */
    }

    #login-btn {
      background-color: #000;
    }

    #signup-btn {
      background-color: #000;
    }

    #login-btn:hover, #signup-btn:hover {
    <!-- 호버할때 animation이 없어서 너무 생동감이없어요 --> background-color: #004080;
    }
  </style>
</head>
<body>


<header>


  <div id="popular-posts" class="left-container">
    <h2>Popular Posts</h2>
    <div style="width: 300px;">Lorem ipsum password application properties hello</div>
  </div>
  <h1 id="welcome-message">팝콘톡에 오신걸 환영합니다</h1>
  <div class="right-container">
    <div class="action-buttons">
      <input type="text" placeholder="Search">
      <button id="login-btn" onclick=moveLogin()>Login</button>
      <button id="signup-btn" onclick=moveSignup()>Signup</button>
    </div>
  </div>
</header>
<div class="center-container">

  <article id="posts" class="post-card">
    <button onclick=createPostData()>게시글 등록</button>
    <p id="post_name">
      <input type="text" id="post_nameInput" placeholder="게시글 제목을 작성해주세요">
    </p>
    <h3 id="post_content">
      <input type="text" id="post_contentInput" placeholder="게시글 내용을 입력해주세요">
    </h3>
    <img id="post_imgPreview" src="#" alt="Post Image" style="display: none;">
    <input type="file" id="post_imgInput" placeholder="게시글 이미지를 업로드해주세요"
           onchange="uploadImage(event)">
  </article>
</div>
<div style="width: 200px; height: 50px;" id="logout-btn" onclick=logout()>로그아웃</div>
</body>

<script>
  function logout() {
    const jwt = sessionStorage.getItem('jwt'); // localStorage에서 'jwt' 토큰 가져오기
    console.log("jwt : {}", jwt);
    if (!jwt) {
      window.location.href = "/users/signup"; // 회원가입 페이지로 리다이렉트
    }
    var logoutBtn = document.querySelector("#logout-btn");
    if (jwt && logoutBtn) {
      logoutBtn.addEventListener('click', function () {
        sessionStorage.clear();
        window.location.href = "/users/testLogin";
      })
    }
  }

  function uploadImage(event) {
    const input = event.target;
    if (input.files && input.files[0]) {
      const formData = new FormData();
      formData.append('Image', input.files[0]);

      fetch('/image', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('HTTP error, status = ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        // 응답 데이터에서 이미지 URL 가져오기
        const imageUrl = data.data.imageUrl;

        // 이미지 미리보기 엘리먼트 가져오기
        const imgPreview = document.getElementById('post_imgPreview');

        // 이미지 URL 설정 및 보이도록 설정
        imgPreview.src = imageUrl;
        imgPreview.style.display = 'block';

        console.log('이미지 업로드 성공:', imageUrl);
      })
      .catch(error => {
        console.error('이미지 업로드 실패:', error);
      });
    }
  }

  async function deleteImage(imageUrl) {
    // 현재 posts에 저장된 게시글 목록중에서 클릭된 이미ㅈ
    try {
      const response = await fetch('/image', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({imageUrl: imageUrl})
      });

      if (!response.ok) {
        throw new Error('이미지 삭제에 실패했습니다.');
      }

      console.log('이미지 삭제에 성공했습니다.');
    } catch (error) {
      console.error('오류 발생:', error);
    }
  }

  async function createPostData() {
    const postNameInput = document.querySelector("#post_nameInput");
    const postContentInput = document.querySelector("#post_contentInput");
    const imgPreview = document.getElementById('post_imgPreview');

    const postName = postNameInput.value.trim();
    const postContent = postContentInput.value.trim();
    const postImageSrc = imgPreview.src;

    // Check if all necessary fields are filled
    if (!postName || !postContent || !postImageSrc || postImageSrc === '#') {
      console.error("게시글 제목, 내용, 이미지를 모두 입력해주세요.");
      return;
    }

    try {
      // Append post element to the posts container
      const postsContainer = document.getElementById('posts');
      const postElement = document.createElement('article');
      postElement.classList.add('post-card');

      // Set post content
      postElement.innerHTML = `
            <button onclick="deletePost(this)">게시글 삭제</button>
            <h2>${postName}</h2>
            <p>${postContent}</p>
            <img src="${postImageSrc}" alt="Post Image">
        `;

      // Prepend post element to the posts container
      postsContainer.prepend(postElement);

      // Clear image input field
      const postImgInput = document.getElementById('post_imgInput');
      postImgInput.value = '';  // Clear the input value

      // Clear input fields
      postNameInput.value = '';
      postContentInput.value = '';
      imgPreview.src = '#';
      imgPreview.style.display = 'none';

      // Send post data to the server
      const postData = {
        postName: postName,
        postContent: postContent,
        postImage: postImageSrc
      };

      console.log('보낼 데이터:', postData); // 데이터 확인용 로그

      const token = sessionStorage.getItem('jwt');

      const response = await fetch('/posts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(postData),
      });

      if (!response.ok) {
        throw new Error('게시글 등록에 실패했습니다.');
      }

      console.log('게시글 등록에 성공했습니다.');
    } catch (error) {
      console.error('오류 발생:', error);
    }
  }

  window.onload = async function() {
    console.log('페이지가 완전히 로드되었습니다.');

    try {
      // getPosts 함수가 Promise를 반환하도록 수정
      await getPosts(0, '');

      // 게시물 요소 찾기
      const postData = document.querySelectorAll('.post-card');
      postData.forEach(post => console.log(post));
    } catch (error) {
      console.error('페이지 로딩 중 오류가 발생했습니다:', error);
    }
  };

  // 코드 수정 예시
  async function getPosts(type, keyword) {
    try {
      const page = 0;
      const size = 10;
      const url = `/posts?type=${type}&keyword=${keyword}&page=${page}&size=${size}`;
      const token = sessionStorage.getItem('jwt');

      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Failed to view post.');
      }

      const responseData = await response.json(); // 이부분에서 문제발생
      console.log('Viewed post data:', responseData);
      displayPosts(responseData);
    } catch (error) {
      console.error('An error occurred:', error);
    }
  }


  function displayPosts(postsData) {
    const postsContainer = document.getElementById('posts');
    postsContainer.innerHTML = ''; // Clear previous posts


    postsData.forEach(post => {
      const article = document.createElement('article');
      article.classList.add('post-card');

      const postTitle = document.createElement('h2');
      postTitle.textContent = post.title;

      const postContent = document.createElement('p');
      postContent.textContent = post.content;

      const postImage = document.createElement('img');
      postImage.src = post.image;
      postImage.alt = 'Post Image';

      article.appendChild(postTitle);
      article.appendChild(postContent);
      article.appendChild(postImage);

      postsContainer.appendChild(article);

      if (postsContainer.hasChildNodes()) {
        console.log("조회 및 화면에 표시 성공!", article);
      }
    });
  }
  function moveLogin(){
    window.location.href="users/testLogin";
  }
  function moveSignup(){
    window.location.href="users/signup";
  }





</script>
</html>

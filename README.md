# Pop-Corn-Talk

![popcorntalk-image](https://github.com/pop-corn-talk/pop-corn-talk/assets/155416976/57bf3205-848a-40ab-bb1a-af3c1f357575)



## ë°°í¬ ì£¼ì†Œ


> **í”„ë¡ íŠ¸ ì„œë²„** : <br> http://52.79.44.5:3000 <br>
> **ë°±ì—”ë“œ ì„œë²„** : <br> http://pct-alb-1518631164.ap-northeast-2.elb.amazonaws.com <br>



## ğŸ‘©â€ğŸ’» íŒ€ì›

<table>
  <tbody>
    <tr>
      <td align="center"><a href="https://github.com/wooseok50"><img src="https://avatars.githubusercontent.com/u/155416976?v=4" width="100px;" alt=""/><br /><sub><b> íŒ€ì¥ : ì¡°ìš°ì„ </b></sub></a><br /></td>
      <td align="center"><a href="https://github.com/Onenyeong"><img src="https://avatars.githubusercontent.com/u/48433827?v=4" width="100px;" alt=""/><br /><sub><b> ë¶€íŒ€ì¥ : ì¥ì›ë…• </b></sub></a><br /></td>
      <td align="center"><a href="https://github.com/dosalpark"><img src="https://avatars.githubusercontent.com/u/108345184?v=4" width="100px;" alt=""/><br /><sub><b> íŒ€ì› : ë°•ìŠ¹í˜„ </b></sub></a><br /></td>
      <td align="center"><a href="https://github.com/parkjungsub"><img src="https://avatars.githubusercontent.com/u/154612223?v=4" width="100px;" alt=""/><br /><sub><b> íŒ€ì› : ë°•ì •ì„­ </b></sub></a><br /></td>
      <td align="center"><a href="https://github.com/harrisbang2"><img src="https://avatars.githubusercontent.com/u/84154173?v=4" width="100px;" alt=""/><br /><sub><b> íŒ€ì› : ë°©ì„¸í›ˆ </b></sub></a><br /></td>
    </tr>
  </tbody>
</table>


---
## í”„ë¡œì íŠ¸ ì†Œê°œ

<aside>
ğŸ’¡ ğŸ¬ğŸ¿ **POP CORN TALK** ğŸ¿ğŸ¬

ğŸŒŸ **ì˜í™”ë¥¼ ì‚¬ë‘í•˜ëŠ” ëª¨ë“  ì´ì—ê²Œ!** **ì˜í™” ë¦¬ë·° SNSë¥¼ ì†Œê°œí•©ë‹ˆë‹¤!** ğŸŒŸ

ğŸ¥ ìš°ë¦¬ í”Œë«í¼ì—ì„œ ì˜í™” ì• í˜¸ê°€ë“¤ë¡œ êµ¬ì„±ëœ í™œë°œí•œ ì»¤ë®¤ë‹ˆí‹°ì— ì°¸ì—¬í•˜ì—¬ ë¦¬ë·°ë¥¼ ê³µìœ í•˜ê³ , ìˆ¨ê²¨ì§„ ë³´ì„ì„ ë°œê²¬í•˜ëŠ” **POP CORN TALK** ì„œë¹„ìŠ¤ì—ì„œ ì°¸ì—¬í•˜ì„¸ìš”!

**ğŸ” ì˜í™” ì„ íƒì— ê³ ë¯¼ì´ë¼ë©´?**

ë‹¹ì‹ ì˜ ì‹œê°„ê³¼ ëˆì„ ì•„ë‚„ ìˆ˜ ìˆëŠ” ì˜í™” ë¦¬ë·°ê°€ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤! ì˜í™”ì— ëŒ€í•œ ì†”ì§í•œ ë¦¬ë·°ë¥¼ ì„œë¡œ ì´ì•¼ê¸°í•˜ë©° ë‹¹ì‹ ì´ ì›í•˜ëŠ” ì˜í™”ë¥¼ ì„ íƒí•˜ëŠ” ë° ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.

**ğŸ“ ë‹¹ì‹ ë„ ë¦¬ë·°ì–´ê°€ ë˜ì–´ë³´ì„¸ìš”!**

ì˜í™”ì— ëŒ€í•œ ì—¬ëŸ¬ë¶„ì˜ ì˜ê²¬ì„ ê³µìœ í•˜ê³  ë‹¤ë¥¸ íŒ¬ë“¤ê³¼ ì†Œí†µí•´ë³´ì„¸ìš”. ìš°ë¦¬ì˜ ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì˜í™”ì— ëŒ€í•œ ëŒ€í™”ì— ì°¸ì—¬í•˜ê³  ìƒˆë¡œìš´ ì¹œêµ¬ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”.

ğŸŒŸÂ **ì„œë¹„ìŠ¤ ì´ìš© ë°©ë²•**

- ì¢‹ì•„í•˜ëŠ” ì˜í™”ì— ëŒ€í•œ ë¦¬ë·° ê²Œì‹œíŒ ê²Œì‹œ ğŸ“
- ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¦¬ë·° ê²Œì‹œíŒì— ëŒ“ê¸€ ë‹¬ê¸° ğŸ’¬
- ì ë¦½í•œ í¬ì¸íŠ¸ë¡œ **POP CORN TALK**ì—ì„œ ì œê³µí•˜ëŠ” ì¿ í°(ì˜í™”í‹°ì¼“, íŒì½˜êµí™˜ê¶Œ)ì„ êµí™˜

ğŸ’° **í¬ì¸íŠ¸ ì ë¦½ ë°©ë²•**

- ê°€ì¥ ëŒ“ê¸€ì´ ë§ì´ ë‹¬ë¦° ë¦¬ë·° ê²Œì‹œíŒì„ ì„ ì •í•˜ì—¬ í¬ì¸íŠ¸ ì§€ê¸‰ ğŸ’°
- ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë©´ í¬ì¸íŠ¸ ì§€ê¸‰ ğŸ’°
- ì»¤ë®¤ë‹ˆí‹° ì´ë²¤íŠ¸ ë° ì±Œë¦°ì§€ì— ì°¸ì—¬í•˜ê¸° ğŸ†
- íšŒì›ê°€ì… ë¦¬ì›Œë“œ ğŸ’°

ğŸŒŸ ì˜í™”ë¥¼ ì‚¬ë‘í•˜ëŠ” ë¶„ë“¤ê³¼ í•¨ê»˜ ì°¸ì—¬í•˜ì—¬ ì˜í™”ì— ëŒ€í•œ ì—´ì •ì„ ê³µìœ í•˜ì„¸ìš”! 

</aside>

#Pop-Corn-Talk #CinemaCommunity #EarnRewards #MovieMagic #SNS

---
## Stacks 

### Backend

- Java  17
- SpringBoot  3.2.4
- MySQL  8.0
- Redis 7.1.0
- SSE
- Log4j2

### Infra

- Docker
- Github Actions
- AWS
    - EC2
    - ECS (Fargate)
    - ECR
    - FARGATE
    - Lambda (EventBridge)
    - RDS(Aurora MySQL)
    - Elasticache
    - S3

### FrontEnd

- React


---
### ì‹¤í–‰í™˜ê²½
```
org.springframework.boot' version '3.2.4
JDK 17
```

---
## ì•„í‚¤í…ì³
![ìŠ¤í¬ë¦°ìƒ· 2024-04-25 165738](https://github.com/pop-corn-talk/pop-corn-talk/assets/155416976/459b45b4-a325-4e00-be4d-87af7ba46b48)



---
## API ëª…ì„¸ì„œ
[https://teamsparta.notion.site/17b7d0c1b7be44a2bf0141b6109ed30d?v=74bc6889cd284f53b7224afaa274f123](https://teamsparta.notion.site/17b7d0c1b7be44a2bf0141b6109ed30d?v=74bc6889cd284f53b7224afaa274f123)


---
## ERD
![erd2](https://github.com/pop-corn-talk/pop-corn-talk/assets/155416976/cf03588e-b481-4eb8-b89b-ea3434bbd5a1)



---
## ì£¼ìš” ê¸°ëŠ¥ 

### ğŸ¿ SNS ì†Œí†µ 
- ì˜í™”ì— ëŒ€í•œ ë¦¬ë·°, ì´ë¯¸ì§€, ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì—¬  ì»¤ë®¤ë‹ˆí‹°ì— ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë³¸ì¸ì˜ ê²Œì‹œê¸€ì— ëŒ“ê¸€ì´ ì‘ì„±ë  ê²½ìš° ì‹¤ì‹œê°„ìœ¼ë¡œ ì•Œë¦¼ì„ ë°›ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸ¿ í¬ì¸íŠ¸ ì ë¦½
- íšŒì›ê°€ì… ì‹œ í¬ì¸íŠ¸ ì ë¦½ ë¦¬ì›Œë“œ
- ì˜í™” ë¦¬ë·° ê²Œì‹œê¸€ ì‘ì„± ì‹œ í¬ì¸íŠ¸ ì ë¦½
- ì „ì›” ê°€ì¥ ì¸ê¸° ìˆëŠ” ê²Œì‹œê¸€ì˜ ë¦¬ë·°ì–´ 3ëª…ì—ê²Œ ì ë¦½ ë¦¬ì›Œë“œ

### ğŸ¿ ì˜í™” í• ì¸ê¶Œ êµ¬ë§¤
- ì ë¦½í•œ í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜í™” í• ì¸ê¶Œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- êµ¬ë§¤í•˜ì‹  ìƒí’ˆì€ êµ¬ë§¤ ë²„íŠ¼ í´ë¦­ê³¼ ë™ì‹œì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ë‹¬ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


# ğŸ› ì„±ëŠ¥ ê°œì„ 

### êµ¬ë§¤ ìš”ì²­ì— ëŒ€í•œ ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜ ìµœì í™”

- ì¬ê³  ê´€ë¦¬ë¥¼ ìœ„í•œ Redis ì ìš©
    - ì¸ë©”ëª¨ë¦¬ ë°ì´í„° êµ¬ì¡° ì €ì¥ì†Œì¸ Redisë¥¼ í™œìš©í•˜ì—¬ ì œí’ˆ ìˆ˜ëŸ‰ì„ ê´€ë¦¬
    - êµ¬ë§¤ ìš”ì²­ì´ ìˆì„ ë•Œë§ˆë‹¤ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šê³ , Redisì—ì„œ ìƒí’ˆ ì¬ê³ ë¥¼ ê´€ë¦¬í•˜ì—¬ ìƒí’ˆì˜ ìˆ˜ëŸ‰ ê°ì†Œ
    - Redisì˜ ì œí’ˆ ìˆ˜ëŸ‰ì´ 0ì— ë„ë‹¬í•˜ì—¬ ì œí’ˆì´ í’ˆì ˆë˜ì—ˆìŒì„ ë‚˜íƒ€ë‚´ëŠ” ê²½ìš°ì—ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì“°ëŠ” ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
    
    ìƒí’ˆì„ DBì— ë“±ë¡í•˜ëŠ” ê³¼ì •ì—ì„œ **hashOperations.put**() ë©”ì„œë“œë¡œ redisì˜ í•´ì‹œ ë§µì— ë°ì´í„° ì¶”ê°€
    
    ```java
    @Override
    @Transactional
    public void createProduct(ProductCreateRequestDto productCreateRequestDto,
        Long userId) {
        userService.validateAdminUser(userId);
        Product product = Product.createOf(productCreateRequestDto);
        Product saveProduct = productRepository.save(product);
    
        hashOperations.put(HASH_KEY, String.valueOf(saveProduct.getId()),
            String.valueOf(saveProduct.getAmount()));
    }
    ```
    ![Untitled](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/b3e7db20-c97a-4965-8e98-b8f81968f3ce)

    
    
    redisì— ìƒí’ˆ id ì™€ ìƒí’ˆ ìˆ˜ëŸ‰ì„ ë“±ë¡
    
    êµ¬ë§¤ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì•„ë˜ ë©”ì„œë“œê°€ ìˆ˜í–‰ë˜ì–´, redisì˜ ìƒí’ˆ ìˆ˜ëŸ‰ ì°¨ê°
    
    ì´í›„ redisì˜ ìƒí’ˆ ìˆ˜ëŸ‰ì´ 0ì´ ë˜ë©´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ì—°ë™ëœ DBì˜ ìƒí’ˆ ìˆ˜ëŸ‰ì„ ì´ˆê¸°í™” í›„ íŒë§¤ì™„ë£Œ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
    
    ```java
    // ìƒí’ˆ ìˆ˜ëŸ‰ ì°¨ê° ë©”ì„œë“œ
    private void deductProductAmount(Product product) {
    
      if (!hashOperations.hasKey(HASH_KEY, String.valueOf(product.getId()))) {
          throw new IllegalArgumentException("ì¬ê³ ê°€ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    
      long incrementCount = hashOperations.increment(HASH_KEY,
          String.valueOf(product.getId()), -1);
    
      if (incrementCount == 0) {
          hashOperations.delete(HASH_KEY, String.valueOf(product.getId()));
          product.updateAmount(0);
          product.softDelete();
      }
    }
    ```
    
    Redisì—ì„œ ìƒí’ˆ ì¬ê³ ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ ë³´ë‹¤ ì²˜ë¦¬ ì†ë„ê°€ ë¹ ë¥´ê³ , ë°ì´í„°ë² ì´ìŠ¤ ì“°ê¸°ë¥¼ ì—°ê¸°í•¨ìœ¼ë¡œì¨ ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ìˆ˜ë¥¼ ìµœì†Œí™”í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì˜ ë¶€ë‹´ ì™„í™”
    

### ì¸ë±ì‹±

- ê²€ìƒ‰ê¸°ëŠ¥ ì¤‘ ë¹„ì¤‘ì´ ë†’ì€ ê²Œì‹œë¬¼ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒ í•  ë•Œì˜ ì†ë„ê°œì„  í•„ìš”ì„±

       **â†’ ì¸ë±ìŠ¤ë¥¼ ì´ìš©í•œ ì¿¼ë¦¬ ìµœì í™”**

- [Test]
    - **[í…ŒìŠ¤íŠ¸ ì¡°ê±´]**
        - **100ëª…ì˜ ì‚¬ìš©ìê°€ 1ì´ˆì— 10ë²ˆ ì ‘ì†**
        - **ê²Œì‹œë¬¼ 100,000 ê°œ ë“±ë¡**

        ![Untitled (1)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/37cb3dfa-5acc-4e0b-bdc2-c0ace54a6c20)
        ![Untitled (2)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/ee6700e0-d0c7-4d6d-8f45-b017ca2d85ad)
        ![Untitled (3)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/d2a95fa9-26bf-4b42-92b9-79fa88b45acb)
      
        - ì ìš© ì „ -> Post_createdAt ì ìš© í›„ :Â  33.2/s => 259.1/sÂ  Â **7.8 ë°° TPS í–¥ìƒ**

### ìºì‹±

- í•„ìˆ˜ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ê±°ë‚˜, ì´ìš©ìì˜ ì ‘ê·¼ì´ ë§ì•„ì„œ DBì— ì¦ì€ ì¡°íšŒê°€ ë°œìƒ

       **â†’ Redis Cache ì ìš©**

- [Test]
    - **[í…ŒìŠ¤íŠ¸ ì¡°ê±´]**
    - **100ëª…ì˜ ì‚¬ìš©ìê°€ 1ì´ˆì— 10ë²ˆ ì ‘ì†í•˜ëŠ” ìƒí™©**
      ![Untitled (4)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/67459aea-3e07-4f8d-9ed1-83f80654780c)
      ![Untitled (5)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/65895e1c-270a-41d4-8822-5b4875f96548)


    - **DBì— ì¡°íšŒ ì¿¼ë¦¬ ìµœì´ˆ 1íšŒ ë°œìƒ,**  **DB ë¶€í•˜â†“**
    - **ìºì‹œì— ë“±ë¡ë˜ê¸° ë•Œë¬¸ì— TPSëŠ” í° ì˜ë¯¸ X**
    
    **ê·¸ë¼íŒŒë‚˜ ì ìš©ìœ¼ë¡œ System Cpu ì‚¬ìš©ëŸ‰ ì¸¡ì •**

    ![Untitled (6)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/a6977cd2-371c-49c1-a99e-3cbb78ae4173)

    
    - ì ìš© ì „: System CPU ì‚¬ìš©ëŸ‰ 0.291
    - ì ìš© í›„: System CPU ì‚¬ìš©ëŸ‰ 0.236
    
          â†’ **19.1%** ì˜ ë¦¬ì†ŒìŠ¤ ì ˆì•½
    

### DB replication

- ì›¹ì‚¬ì´íŠ¸ì˜ ì½ê¸°ì™€ ì“°ê¸° ë¹„ì¤‘ì€ ì½ê¸° ë¹„ì¤‘ì´ ë†’ìŒ

      ****ë”°ë¼ì„œ ë³µì¡í•œ ë¡œì§ì´ ë‹¤ìˆ˜ ìˆ˜í–‰ë  ê²½ìš° ë’¤ì˜ ì½ê¸°, ì“°ê¸° ì‘ì—…ì˜ ì²˜ë¦¬ì†ë„ ì§€ì—° ë°œìƒ ****

      **â†’ DB Replication ì ìš©**

- [Test]
    
    **[í…ŒìŠ¤íŠ¸ ì¡°ê±´]**
    
    - 100ëª…ì˜ ì‚¬ìš©ìê°€ 1ì´ˆì— 10ë²ˆ ì ‘ì†í•˜ëŠ” ìƒí™©
    - Getìš”ì²­ì€ 100,000ê±´ì˜ ë°ì´í„° ì¤‘ 10ê°œì˜ íŠ¹ì •í•œ ë°ì´í„°ë¥¼ ì¡°íšŒ
    
      ![Untitled (7)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/3279180b-1ab4-473b-9ace-76aa1a7f01ab)
      ![Untitled (8)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/46c83aed-b143-4782-b215-ee56fa0c1b80)

  
    - ì½ê¸° :Â  21.8/s => 29.7/sÂ  Â **36.2% TPS í–¥ìƒ**
    - ì“°ê¸° :Â  23.0/s => 28.6/sÂ  Â **24.3% TPS í–¥ìƒ**(post, post2ì˜ í‰ê· ê°’ìœ¼ë¡œ ê³„ì‚°)
    - í•©ê³„ :Â  63.7/s => 83.3/sÂ Â  **30.7% TPS í–¥ìƒ**

# ğŸ› Â íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ìŠ¤ì¼€ì¥´ë§

- [ë¬¸ì œ ìƒí™© & ì›ì¸]
    - íŠ¹ì • ì¡°ê±´ì— ì˜í•´ ìë™ìœ¼ë¡œ í¬ì¸íŠ¸ë¥¼ ì§€ê¸‰í•˜ëŠ” ë©”ì„œë“œ ìˆ˜í–‰ê³¼ì •
    - @Scheduler í†µí•´ êµ¬í˜„í•œ ë©”ì„œë“œë¡œ ë‹¨ì¼ ì„œë²„ í™˜ê²½ì—ì„œ ì •ìƒ ë™ì‘
    - í•˜ì§€ë§Œ ë°°í¬ í›„ ë©€í‹° ì„œë²„ í™˜ê²½ì—ì„œëŠ” í•´ë‹¹ ë©”ì†Œë“œê°€ ì„œë²„ì˜ ìˆ˜ ë§Œí¼ ë™ì‘í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ + í¬ì¸íŠ¸ ì¶”ê°€ ì§€ê¸‰ ë¬¸ì œ ë°œìƒ
- [í•´ê²° ê³¼ì •]
    - í•˜ë‚˜ì˜ ì„œë²„ì—ì„œ ë§Œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ê¸°ì— Spring batch, AWS Lambdaë¥¼ ì´ìš©í•˜ì—¬ ì§€ì •ëœ ì‹œê°„ì— ìŠ¤ì¼€ì¥´ë§ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨
    - Spring batchëŠ” ìŠ¤ì¼€ì¥´ë§ ê¸°ëŠ¥ì€ ìˆì§€ë§Œ ëŒ€ìš©ëŸ‰ ë°ì´í„° ìë™í™” ì²˜ë¦¬ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‚˜ì™”ìœ¼ë©°, ë³„ë„ì˜ ì„œë²„ë¥¼ ì„¤ì¹˜ ë° êµ¬ì„±í•´ì•¼ í•œë‹¤ëŠ” ì ì—ì„œ AWSì—ì„œ ì œê³µí•˜ëŠ” ì„œë²„ë¦¬ìŠ¤ ì„œë¹„ìŠ¤ì¸ Lambdaì™€ EventBridgeë¥¼ ì´ìš©í•˜ì—¬ ìŠ¤ì¼€ì¥´ë§ì„ êµ¬í˜„
        ![Untitled (9)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/db75c910-e0c0-4e84-bbd0-8237adae72f6)
        ![Untitled (10)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/fae04004-82b9-46ae-a90e-188af1579c5f)
    - Lambdaì— ì‹¤í–‰ í•  Http ë©”ì†Œë“œë¥¼ ê¸°ì¬í•˜ê³  ì›í•˜ëŠ” ì‹œê°„ì— EventBridgeì—ì„œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œì¼œì„œ Lambdaê°€ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •

### ë™ì‹œì„± ì œì–´

- [ë¬¸ì œ ìƒí™© 1]
    - ìƒí’ˆì„ êµí™˜í•˜ëŠ” ë¡œì§ì—ì„œ êµ¬ë§¤ ìˆ˜ëŸ‰ë³´ë‹¤ ìƒí’ˆì˜ ìˆ˜ëŸ‰ì´ ì ê²Œ ì°¨ê°ë˜ëŠ” ë™ì‹œì„± ë¬¸ì œ ë°œìƒ
    
    [ì›ì¸]
    
    - ë³„ë„ì˜ ë½ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•Šì•„ì„œ ë‹¤ìˆ˜ì˜ ì´ìš©ìê°€ ìƒí’ˆì„ êµ¬ë§¤ í•  ë•Œ ë™ì‹œì— êµ¬ë§¤í•˜ê²Œ ë˜ì„œ ìˆ˜ëŸ‰ì´ ì •ìƒì ìœ¼ë¡œ ì°¨ê°ë˜ì§€ ì•ŠëŠ” ë¬¸ì œ
    
    [í•´ê²° ê³¼ì •]
    
    - ì‹±ê¸€ì“°ë ˆë“œë¡œ ë™ì‘í•˜ëŠ” Redisì˜ íŠ¹ì„±ì„ ì´ìš©, hashTableì„ í†µí•œ ìƒí’ˆì¬ê³  ê´€ë¦¬ ë° ë™ì‹œì„± ì œì–´
      ![Untitled (11)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/1cfe5d31-8228-4c6c-a30b-f3ec302cf65e)
      ![Untitled (12)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/081b0872-827f-4246-849b-5c310d99de4b)
      
- [ë¬¸ì œ ìƒí™© 2]
    - ê´€ë¦¬ìê°€ ìƒí’ˆì˜ ì •ë³´ë¥¼ ìˆ˜ì • ë° ì‚­ì œ í•˜ëŠ” ê³¼ì •ì—ì„œ ìœ ì €ì˜ ìƒí’ˆ êµ¬ë§¤ ìš”ì²­ì´ ì„±ê³µí•˜ëŠ” ìƒí™© ë°œìƒ
    
    [í•´ê²° ê³¼ì •] 
    
    - Redisì˜ Redisson ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ pub/sub ë°©ì‹ì˜ ë¶„ì‚°ë½ êµ¬í˜„
    
    ```java
    // DistributedLockAop.java
    @Aspect
    @Component
    @Slf4j(topic = "DistributedLock ì„¤ì •")
    @AllArgsConstructor
    public class DistributedLockAop {
    
        private final RedissonClient redissonClient;
        private final AopForTransaction aopForTransaction;
    
        @Around("@annotation(com.popcorntalk.global.annotation.DistributedLock)")
        public Object lock(ProceedingJoinPoint joinPoint) throws Throwable {
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            DistributedLock distributedLock = method.getAnnotation(DistributedLock.class);
    
            String baseKey = distributedLock.lockName();
            String dynamicKey = generateDynamicKey(signature.getParameterNames(), joinPoint.getArgs(),
                distributedLock.identifier());
            String key = baseKey + " : " + dynamicKey;
            RLock lock = redissonClient.getFairLock(key);
    
            log.info("{} - ë½ íšë“ ì‹œë„", key);
            try {
                boolean lockAcquired = lock.tryLock(distributedLock.waitTime(),
                    distributedLock.leaseTime(), distributedLock.timeUnit());
                if (!lockAcquired) {
                    log.info("{} - ë½ íšë“ ì‹¤íŒ¨", key);
                    throw new IllegalArgumentException(key + " - RLock íšë“ ì‹¤íŒ¨");
                }
    
                log.info("{} - ë½ íšë“ ì„±ê³µ", key);
                return aopForTransaction.proceed(joinPoint);
            } finally {
                try {
                    if (lock.isHeldByCurrentThread()) {
                        lock.unlock();
                    }
                    log.info("{} - ë½ ë°˜ë‚©", key);
                } catch (IllegalMonitorStateException e) {
                    log.info(e + baseKey + dynamicKey);
                }
            }
        }
    
    ```
    
    - ìƒí’ˆì˜ ìˆ˜ì •, ì‚­ì œ , êµ¬ë§¤ ì¤‘ ë‹¤ë¥¸ ìœ ì €ê°€ ìƒí’ˆì— ì ‘ê·¼ í•  ìˆ˜ ì—†ë„ë¡ ìƒí’ˆì˜ IDë¡œ ë¶„ì‚°ë½ ì ìš©
    - ì„¤ì • ì¤‘ ì½”ë“œì˜ ì¤‘ë³µì´ ë°œìƒí•˜ì—¬ì„œ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ ìƒì„±í•˜ì—¬ ì½”ë“œì˜ ì¤‘ë³µ ìµœì†Œí™”
    
    ```java
    	// ExchangeServiceImpl.java, ìƒí’ˆ êµ¬ë§¤ ë¡œì§ ë©”ì„œë“œ
    	@Override
      @DistributedLock(lockName = "product", identifier = "productId", waitTime = 60, leaseTime = 4)
      public void createExchange(Long userId, Long productId) {
    
          Product product = productService.getProduct(productId);
    
          pointService.checkUserPoint(userId, product.getPrice());
    
          productAmount(product);
    
          pointService.deductPointForPurchase(userId, product.getPrice());
    
          Exchange exchange = Exchange.createOf(userId, product.getId(), product.getVoucherImage());
          exchangeRepository.save(exchange);
    
          notificationService.notifyPurchase(userId, ADMIN_EMAIL, product.getVoucherImage());
      }
    ```
    

### Jwt Refresh  í† í° ì¬ë°œê¸‰ ë³´ì•ˆ ë¬¸ì œ.

- [ë¬¸ì œ ìƒí™©]
    - í† í°ì„ ì¡°ì‘ í•´ì„œ ìƒˆë¡œìš´ í† í°ì„ ë°œê¸‰ ë°›ì„ ìˆ˜ ìˆëŠ” ë¬¸ì œ
    - ë§Œë£Œëœ ì´ì „ Access Tokenì„ í†µí•´ì„œ í† í°ì„ ì¬ë°œê¸‰ ë°›ì„ ìˆ˜ ìˆìŒ
- [ì›ì¸]
    - í† í°ì„ ì¬ë°œê¸‰ í•  ë•Œ ìœ ì € ê°€ ë™ì¼ í•œì§€ë§Œ ê²€ì¦ í•¨
- [í•´ê²° ë°©ë²•]
    - refresh í† í°ì´ ì €ì¥ë˜ì–´ ìˆëŠ” cache ì— ê°€ì¥ ìµœê·¼ì— ë°œê¸‰í•œ Access í† í°ì„ í¬í•¨ ì‹œì¼œì„œ ìƒˆë¡œìš´ í† í° ë°œê¸‰ ìš”ì²­ ì‹œ ë¡œê·¸ì¸ í•  ë•Œ ì „ë‹¬í•œ Access í† í° ê¹Œì§€ ê²€ì¦
    
    ![Untitled (13)](https://github.com/Onenyeong/pop-corn-talks/assets/108345184/4aefc09c-c86f-417b-a5ca-9e1b2efb7270)


### RedisConfigì˜ ë³µìˆ˜ì˜ CacheManager ë¬¸ì œ

- [ë¬¸ì œ ìƒí™©]
    - í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰ì¤‘ ì•„ë˜ì˜ Exception ë°œìƒ
    
    ```java
    No CacheResolver specified, and no unique bean of type CacheManager found. 
    Mark one as primary or declare a specific CacheManager to use. excetion
    ```
    
- [ì›ì¸]
    
    ì„¤ì •ì´ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë¥¼ ìœ„í•´ RedisConfigì— ì¶”ê°€ë¡œ CacheManagerë¥¼ ìƒì„±
    ë‹¤ìˆ˜ì˜ CacheManagerê°€ í”„ë¡œì íŠ¸ ì‹¤í–‰ì‹œì— ì˜¬ë¼ì™€ì„œ ë°œìƒí•œ ë¬¸ì œ
    
    ```java
    // CacheAspectSupport.class
    @Override
    public void afterSingletonsInstantiated() {
    	if (getCacheResolver() == null) {
    		// Lazily initialize cache resolver via default cache manager
    		Assert.state(this.beanFactory != null, "CacheResolver or BeanFactory must be set on cache aspect");
    		try {
    			setCacheManager(this.beanFactory.getBean(CacheManager.class));
    		}
    		catch (NoUniqueBeanDefinitionException ex) {
    			throw new IllegalStateException("No CacheResolver specified, and no unique bean of type " +
    					"CacheManager found. Mark one as primary or declare a specific CacheManager to use.", ex);
    		}
    		catch (NoSuchBeanDefinitionException ex) {
    			throw new IllegalStateException("No CacheResolver specified, and no bean of type CacheManager found. " +
    					"Register a CacheManager bean or remove the @EnableCaching annotation from your configuration.", ex);
    		}
    	}
    	this.initialized = true;
    	}
    ```
    
- [í•´ê²° ê³¼ì •]
    - CacheManagerì¤‘ í•˜ë‚˜ë¥¼ Primaryë¡œ ë“±ë¡í•´ì£¼ì–´ì•¼ í•˜ë©° í•˜ë‚˜ì˜ CacheManagerì— @Primary ì–´ë…¸í…Œì´ì…˜ ë¶™í˜€ì„œ ê¸°ë³¸ CacheManager ê°’ì„ ì§€ì •í•˜ì—¬  ì¡°ì¹˜ ì™„ë£Œ
    
    ```jsx
     		@Bean(name = "cacheManager")
        @Primary
        public CacheManager cacheManager() {
            RedisCacheManager.RedisCacheManagerBuilder builder =
                RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(
                    redisConnectionFactory());
    
            RedisCacheConfiguration configuration = RedisCacheConfiguration.defaultCacheConfig()
                .serializeValuesWith(
                    RedisSerializationContext.SerializationPair.fromSerializer(
                        new GenericJackson2JsonRedisSerializer())) // Value Serializer ë³€ê²½
                .disableCachingNullValues()
                .entryTtl(Duration.ofMinutes(10L));
    
            builder.cacheDefaults(configuration);
    
            return builder.build();
        }
    ```
